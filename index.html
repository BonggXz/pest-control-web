<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Alat Pengusir Hama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #10b981;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        .active-device {
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
            border: 2px solid #10b981;
        }
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
        @keyframes pulse-green {
            0%, 100% { background-color: #10b981; }
            50% { background-color: #059669; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-bug mr-3 text-green-600"></i>
                        Control Pengusir Hama
                    </h1>
                    <p class="text-gray-600 mt-2">Sistem kontrol otomatis dan manual untuk perangkat pengusir hama</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Status Sistem</div>
                        <div id="systemStatus" class="text-lg font-semibold text-green-600">Connecting...</div>
                    </div>
                    <div id="connectionIndicator" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Mode Selection -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cog mr-2 text-green-600"></i>
                    Mode Operasi
                </h2>
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-hand-paper text-blue-500 mr-3 text-xl"></i>
                            <div>
                                <div class="font-semibold">Mode Manual</div>
                                <div class="text-sm text-gray-600">Kontrol langsung perangkat</div>
                            </div>
                        </div>
                        <input type="radio" name="mode" value="manual" id="manualMode" class="form-radio text-green-600" checked>
                    </div>
                    <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <i class="fas fa-clock text-green-500 mr-3 text-xl"></i>
                            <div>
                                <div class="font-semibold">Mode Otomatis</div>
                                <div class="text-sm text-gray-600">Berdasarkan jadwal waktu</div>
                            </div>
                        </div>
                        <input type="radio" name="mode" value="auto" id="autoMode" class="form-radio text-green-600">
                    </div>
                </div>
            </div>

            <!-- Manual Control -->
            <div id="manualControl" class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-gamepad mr-2 text-green-600"></i>
                    Kontrol Manual
                </h2>
                <div class="space-y-6">
                    <!-- UV Light Control -->
                    <div class="flex items-center justify-between p-4 border rounded-lg" id="uvDevice">
                        <div class="flex items-center">
                            <i class="fas fa-lightbulb text-yellow-500 mr-3 text-2xl"></i>
                            <div>
                                <div class="font-semibold text-lg">Lampu UV</div>
                                <div class="text-sm text-gray-600">Sinar ultraviolet untuk mengusir serangga</div>
                                <div id="uvStatus" class="text-sm font-medium text-red-600">OFF</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="uvToggle">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <!-- Ultrasonic Sound Control -->
                    <div class="flex items-center justify-between p-4 border rounded-lg" id="soundDevice">
                        <div class="flex items-center">
                            <i class="fas fa-volume-up text-purple-500 mr-3 text-2xl"></i>
                            <div>
                                <div class="font-semibold text-lg">Suara Ultrasonik</div>
                                <div class="text-sm text-gray-600">Gelombang suara untuk mengusir hama</div>
                                <div id="soundStatus" class="text-sm font-medium text-red-600">OFF</div>
                            </div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="soundToggle">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Automatic Schedule Settings -->
        <div id="autoSettings" class="bg-white rounded-lg shadow-md p-6 mt-6 hidden">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-calendar-alt mr-2 text-green-600"></i>
                Pengaturan Jadwal Otomatis
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- UV Schedule -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
                        Jadwal Lampu UV
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <label class="toggle-switch mr-3">
                                <input type="checkbox" id="uvScheduleEnabled">
                                <span class="slider"></span>
                            </label>
                            <span class="font-medium">Aktifkan Jadwal</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label>
                                <input type="time" id="uvStartTime" class="w-full border rounded-md px-3 py-2" value="20:00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Selesai</label>
                                <input type="time" id="uvEndTime" class="w-full border rounded-md px-3 py-2" value="06:00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hari Aktif</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="1" checked> Sen
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="2" checked> Sel
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="3" checked> Rab
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="4" checked> Kam
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="5" checked> Jum
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="6" checked> Sab
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 uv-day" data-day="0" checked> Min
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sound Schedule -->
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold text-lg mb-4 flex items-center">
                        <i class="fas fa-volume-up text-purple-500 mr-2"></i>
                        Jadwal Suara Ultrasonik
                    </h3>
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <label class="toggle-switch mr-3">
                                <input type="checkbox" id="soundScheduleEnabled">
                                <span class="slider"></span>
                            </label>
                            <span class="font-medium">Aktifkan Jadwal</span>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label>
                                <input type="time" id="soundStartTime" class="w-full border rounded-md px-3 py-2" value="19:00">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Jam Selesai</label>
                                <input type="time" id="soundEndTime" class="w-full border rounded-md px-3 py-2" value="07:00">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Hari Aktif</label>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="1" checked> Sen
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="2" checked> Sel
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="3" checked> Rab
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="4" checked> Kam
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="5" checked> Jum
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="6" checked> Sab
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" class="mr-1 sound-day" data-day="0" checked> Min
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- WhatsApp Notification Settings -->
        <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fab fa-whatsapp mr-2 text-green-600"></i>
                Pengaturan Notifikasi WhatsApp
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp Penerima</label>
                    <div class="flex">
                        <span class="inline-flex items-center px-3 text-sm text-gray-900 bg-gray-200 border border-r-0 border-gray-300 rounded-l-md">
                            +62
                        </span>
                        <input type="tel" id="whatsappNumber" placeholder="81234567890" 
                               class="flex-1 border border-gray-300 rounded-r-md px-3 py-2 text-sm">
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Masukkan nomor tanpa +62</p>
                </div>
                
                <div class="flex items-center">
                    <label class="toggle-switch mr-3">
                        <input type="checkbox" id="notificationEnabled">
                        <span class="slider"></span>
                    </label>
                    <div>
                        <div class="font-medium">Aktifkan Notifikasi</div>
                        <div class="text-sm text-gray-600">Kirim pesan otomatis ke WhatsApp</div>
                    </div>
                </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Device Control Message -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pesan Kontrol Alat</label>
                    <textarea id="customMessage" rows="4" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                              placeholder="Masukkan pesan untuk notifikasi kontrol alat...">ü¶ó *Pengusir Hama Aktif*

Sistem pengusir hama telah diaktifkan secara otomatis.

‚è∞ Waktu: {waktu}
üî¶ UV Light: {status_uv}
üîä Ultrasonik: {status_sound}

Semoga area Anda terlindungi dari hama! üõ°Ô∏è</textarea>
                </div>

                <!-- Pesticide Schedule Message -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pesan Jadwal Penyiraman Pestisida</label>
                    <textarea id="pesticideMessage" rows="4" 
                              class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm"
                              placeholder="Masukkan pesan untuk reminder pestisida...">üåæ *Reminder Penyiraman Pestisida*

Saatnya melakukan penyiraman pestisida!

üìÖ Tanggal: {tanggal}
‚è∞ Waktu: {waktu}

Jangan lupa:
‚Ä¢ Gunakan masker dan sarung tangan
‚Ä¢ Pastikan cuaca tidak berangin
‚Ä¢ Semprot merata ke seluruh tanaman

Selamat bekerja! üí™</textarea>
                </div>
            </div>

            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Jadwal Penyiraman Pestisida</label>
                <input type="date" id="pesticideSchedule" 
                       class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                <p class="text-xs text-gray-500 mt-1">
                    Pilih tanggal untuk reminder penyiraman pestisida
                </p>
            </div>

            <div class="mt-6 flex space-x-4">
                <button id="testDeviceNotification" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors flex items-center">
                    <i class="fab fa-whatsapp mr-2"></i>
                    Test Notifikasi Alat
                </button>
                <button id="testPesticideNotification" class="bg-orange-600 text-white px-4 py-2 rounded-md hover:bg-orange-700 transition-colors flex items-center">
                    <i class="fas fa-spray-can mr-2"></i>
                    Test Notifikasi Pestisida
                </button>
            </div>

            <div class="mt-4 text-xs text-gray-500">
                <p><strong>Variabel yang tersedia:</strong></p>
                <p>‚Ä¢ {waktu} - Waktu saat ini</p>
                <p>‚Ä¢ {tanggal} - Tanggal saat ini</p>
                <p>‚Ä¢ {status_uv} - Status lampu UV</p>
                <p>‚Ä¢ {status_sound} - Status suara ultrasonik</p>
            </div>
        </div>

        <!-- Save Settings -->
        <div class="mt-6 flex justify-end">
            <button id="saveSettings" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition-colors flex items-center text-lg">
                <i class="fas fa-save mr-2"></i>
                Simpan Pengaturan
            </button>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBPMUPdJb2JHKdACVpIhQf3CyGMzeE6mVs",
            authDomain: "pest-control-system-393aa.firebaseapp.com",
            databaseURL: "https://pest-control-system-393aa-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "pest-control-system-393aa",
            storageBucket: "pest-control-system-393aa.firebasestorage.app",
            messagingSenderId: "579240324253",
            appId: "1:579240324253:web:42de253d48aed3d995b874"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // State management
        let settings = {
            mode: 'manual',
            uv: { active: false, schedule: { enabled: false, start: '20:00', end: '06:00', days: [1,1,1,1,1,1,1] }},
            sound: { active: false, schedule: { enabled: false, start: '19:00', end: '07:00', days: [1,1,1,1,1,1,1] }},
            notification: { 
                enabled: false, 
                number: '', 
                message: '',
                pesticideSchedule: '',
                pesticideMessage: ''
            }
        };

        // DOM Elements
        const manualMode = document.getElementById('manualMode');
        const autoMode = document.getElementById('autoMode');
        const manualControl = document.getElementById('manualControl');
        const autoSettings = document.getElementById('autoSettings');
        const uvToggle = document.getElementById('uvToggle');
        const soundToggle = document.getElementById('soundToggle');
        const uvDevice = document.getElementById('uvDevice');
        const soundDevice = document.getElementById('soundDevice');
        const uvStatus = document.getElementById('uvStatus');
        const soundStatus = document.getElementById('soundStatus');
        const systemStatus = document.getElementById('systemStatus');
        const connectionIndicator = document.getElementById('connectionIndicator');

        // Initialize Firebase listeners
        function initFirebaseListeners() {
            // Listen for device status changes
            database.ref('status').on('value', (snapshot) => {
                const status = snapshot.val();
                if (status) {
                    updateDeviceStatus('uv', status.uvActive);
                    updateDeviceStatus('sound', status.soundActive);
                    
                    if (status.online) {
                        systemStatus.textContent = 'Online';
                        systemStatus.className = 'text-lg font-semibold text-green-600';
                        connectionIndicator.className = 'w-3 h-3 bg-green-500 rounded-full pulse-green';
                    } else {
                        systemStatus.textContent = 'Offline';
                        systemStatus.className = 'text-lg font-semibold text-red-600';
                        connectionIndicator.className = 'w-3 h-3 bg-red-500 rounded-full animate-pulse';
                    }
                }
            });

            // Listen for settings changes
            database.ref('settings').on('value', (snapshot) => {
                const fbSettings = snapshot.val();
                if (fbSettings) {
                    loadSettingsFromFirebase(fbSettings);
                }
            });
        }

        // Mode switching
        function switchMode() {
            const isAuto = autoMode.checked;
            settings.mode = isAuto ? 'auto' : 'manual';
            
            if (isAuto) {
                manualControl.classList.add('hidden');
                autoSettings.classList.remove('hidden');
            } else {
                manualControl.classList.remove('hidden');
                autoSettings.classList.add('hidden');
            }

            // Update Firebase
            database.ref('settings/mode').set(settings.mode);
        }

        // Manual control functions
        function toggleUV() {
            if (settings.mode === 'manual') {
                settings.uv.active = uvToggle.checked;
                database.ref('control/uv').set(settings.uv.active);
            }
        }

        function toggleSound() {
            if (settings.mode === 'manual') {
                settings.sound.active = soundToggle.checked;
                database.ref('control/sound').set(settings.sound.active);
            }
        }

        function updateDeviceStatus(device, active) {
            if (device === 'uv') {
                uvToggle.checked = active;
                uvStatus.textContent = active ? 'ON' : 'OFF';
                uvStatus.className = active ? 'text-sm font-medium text-green-600' : 'text-sm font-medium text-red-600';
                if (active) {
                    uvDevice.classList.add('active-device');
                } else {
                    uvDevice.classList.remove('active-device');
                }
            } else if (device === 'sound') {
                soundToggle.checked = active;
                soundStatus.textContent = active ? 'ON' : 'OFF';
                soundStatus.className = active ? 'text-sm font-medium text-green-600' : 'text-sm font-medium text-red-600';
                if (active) {
                    soundDevice.classList.add('active-device');
                } else {
                    soundDevice.classList.remove('active-device');
                }
            }
        }

        // Notification functions
        function testDeviceNotification() {
            const number = document.getElementById('whatsappNumber').value;
            const message = document.getElementById('customMessage').value;
            
            if (!number) {
                alert('Masukkan nomor WhatsApp terlebih dahulu!');
                return;
            }

            sendTestMessage(message, 'device');
        }

        function testPesticideNotification() {
            const number = document.getElementById('whatsappNumber').value;
            const message = document.getElementById('pesticideMessage').value;
            
            if (!number) {
                alert('Masukkan nomor WhatsApp terlebih dahulu!');
                return;
            }

            sendTestMessage(message, 'pesticide');
        }

        function sendTestMessage(message, type) {
            const number = document.getElementById('whatsappNumber').value;
            
            // Replace placeholders with actual data
            const now = new Date();
            const processedMessage = message
                .replace('{waktu}', now.toLocaleString('id-ID'))
                .replace('{tanggal}', now.toLocaleDateString('id-ID'))
                .replace('{status_uv}', settings.uv.active ? 'Aktif' : 'Tidak Aktif')
                .replace('{status_sound}', settings.sound.active ? 'Aktif' : 'Tidak Aktif');

            // Send via WhatsApp API
            fetch('https://your-whatsapp-api.vercel.app/api/send-message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    to: '62' + number,
                    message: processedMessage
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Pesan test berhasil dikirim!');
                } else {
                    alert('Gagal mengirim pesan: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                // Fallback to WhatsApp Web
                const whatsappUrl = `https://wa.me/62${number}?text=${encodeURIComponent(processedMessage)}`;
                window.open(whatsappUrl, '_blank');
            });
        }

        // Save settings
        function saveSettings() {
            // Collect all settings
            settings.notification.enabled = document.getElementById('notificationEnabled').checked;
            settings.notification.number = document.getElementById('whatsappNumber').value;
            settings.notification.message = document.getElementById('customMessage').value;
            settings.notification.pesticideSchedule = document.getElementById('pesticideSchedule').value;
            settings.notification.pesticideMessage = document.getElementById('pesticideMessage').value;
            
            // Collect UV schedule
            settings.uv.schedule.enabled = document.getElementById('uvScheduleEnabled').checked;
            settings.uv.schedule.start = document.getElementById('uvStartTime').value;
            settings.uv.schedule.end = document.getElementById('uvEndTime').value;
            
            const uvDays = document.querySelectorAll('.uv-day');
            uvDays.forEach((checkbox, index) => {
                const day = parseInt(checkbox.dataset.day);
                settings.uv.schedule.days[day] = checkbox.checked ? 1 : 0;
            });
            
            // Collect Sound schedule
            settings.sound.schedule.enabled = document.getElementById('soundScheduleEnabled').checked;
            settings.sound.schedule.start = document.getElementById('soundStartTime').value;
            settings.sound.schedule.end = document.getElementById('soundEndTime').value;
            
            const soundDays = document.querySelectorAll('.sound-day');
            soundDays.forEach((checkbox, index) => {
                const day = parseInt(checkbox.dataset.day);
                settings.sound.schedule.days[day] = checkbox.checked ? 1 : 0;
            });

            // Save to Firebase
            database.ref('settings').set(settings)
                .then(() => {
                    alert('Pengaturan berhasil disimpan!');
                })
                .catch((error) => {
                    alert('Gagal menyimpan pengaturan: ' + error.message);
                });
        }

        function loadSettingsFromFirebase(fbSettings) {
            if (fbSettings.mode) {
                settings.mode = fbSettings.mode;
                if (fbSettings.mode === 'auto') {
                    autoMode.checked = true;
                } else {
                    manualMode.checked = true;
                }
                switchMode();
            }

            if (fbSettings.notification) {
                settings.notification = fbSettings.notification;
                document.getElementById('notificationEnabled').checked = fbSettings.notification.enabled || false;
                document.getElementById('whatsappNumber').value = fbSettings.notification.number || '';
                document.getElementById('customMessage').value = fbSettings.notification.message || '';
                document.getElementById('pesticideSchedule').value = fbSettings.notification.pesticideSchedule || '';
                document.getElementById('pesticideMessage').value = fbSettings.notification.pesticideMessage || '';
            }

            if (fbSettings.uv && fbSettings.uv.schedule) {
                const uvSched = fbSettings.uv.schedule;
                document.getElementById('uvScheduleEnabled').checked = uvSched.enabled || false;
                document.getElementById('uvStartTime').value = uvSched.start || '20:00';
                document.getElementById('uvEndTime').value = uvSched.end || '06:00';
                
                if (uvSched.days) {
                    const uvDays = document.querySelectorAll('.uv-day');
                    uvDays.forEach(checkbox => {
                        const day = parseInt(checkbox.dataset.day);
                        checkbox.checked = uvSched.days[day] === 1;
                    });
                }
            }

            if (fbSettings.sound && fbSettings.sound.schedule) {
                const soundSched = fbSettings.sound.schedule;
                document.getElementById('soundScheduleEnabled').checked = soundSched.enabled || false;
                document.getElementById('soundStartTime').value = soundSched.start || '19:00';
                document.getElementById('soundEndTime').value = soundSched.end || '07:00';
                
                if (soundSched.days) {
                    const soundDays = document.querySelectorAll('.sound-day');
                    soundDays.forEach(checkbox => {
                        const day = parseInt(checkbox.dataset.day);
                        checkbox.checked = soundSched.days[day] === 1;
                    });
                }
            }
        }

        // Event listeners
        manualMode.addEventListener('change', switchMode);
        autoMode.addEventListener('change', switchMode);
        uvToggle.addEventListener('change', toggleUV);
        soundToggle.addEventListener('change', toggleSound);
        document.getElementById('testDeviceNotification').addEventListener('click', testDeviceNotification);
        document.getElementById('testPesticideNotification').addEventListener('click', testPesticideNotification);
        document.getElementById('saveSettings').addEventListener('click', saveSettings);

        // Initialize
        initFirebaseListeners();
        switchMode();
        
        // Set default pesticide message if empty
        if (!document.getElementById('pesticideMessage').value) {
            document.getElementById('pesticideMessage').value = `üåæ *Reminder Penyiraman Pestisida*

Saatnya melakukan penyiraman pestisida!

üìÖ Tanggal: {tanggal}
‚è∞ Waktu: {waktu}

Jangan lupa:
‚Ä¢ Gunakan masker dan sarung tangan
‚Ä¢ Pastikan cuaca tidak berangin
‚Ä¢ Semprot merata ke seluruh tanaman

Selamat bekerja! üí™`;
        }
    </script>
</body>
</html>